<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ form_title }}</title>
    <style>
    /* TOÀN BỘ CODE CSS TỪ FILE GỐC CỦA BẠN DÁN VÀO ĐÂY */
    body { font-family: Arial, sans-serif; margin: 15px; background-color: #f4f4f9; }
    .container { max-width: 900px; margin: auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    h1 { color: #333; text-align: center; padding-bottom: 0px; margin-bottom: 0px; font-size: 1.8em; } 
    .subtitle { text-align: center; color: #555; font-size: 1.1em; font-weight: bold; margin-top: 5px; padding-bottom: 10px; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
    .explanation { text-align: justify; margin-bottom: 25px; padding: 10px; border: 1px dashed #ccc; border-radius: 4px; background-color: #fff; font-size: 0.95em; line-height: 1.5; }
    .explanation strong { color: #0056b3; }
    h3 { color: #0056b3; border-left: 5px solid #0056b3; padding-left: 10px; margin-top: 25px; margin-bottom: 15px; }
    label { display: block; margin-bottom: 8px; font-weight: bold; } 
    input[type="text"], textarea, select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .form-group { margin-bottom: 25px; } 
    .radio-group label { display: inline-block; font-weight: normal; margin-right: 15px; }
    .radio-group input[type="radio"] { margin-right: 5px; }
    button { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; transition: background-color 0.3s; }
    button:hover { background-color: #218838; }
    .feedback { text-align: center; margin-top: 15px; font-weight: bold; }
    .hidden { display: none; }
    input[readonly] { background-color: #eee; cursor: default; }
    .section-box { border-radius: 6px; padding: 20px; margin-bottom: 30px; background-color: #ffffff; }
    .section-a { border: 2px solid #28a745; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2); }
    .section-b { border: 2px solid #007bff; box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2); }
    .section-c { border: 2px solid #fd7e14; box-shadow: 0 4px 8px rgba(253, 126, 20, 0.2); }
    .info-row { display: flex; gap: 20px; margin-bottom: 15px; }
    .info-col { flex-grow: 1; min-width: 0; }
    .ma-nv-col { flex-grow: 0.5; max-width: 150px; } 
    .name-dept-col { flex-grow: 1.5; }
    .survey-grid { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
    .survey-grid th, .survey-grid td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .survey-grid th { background-color: #f2f2f2; font-weight: bold; text-align: center; }
    .survey-grid thead th:first-child { width: 55% !important; font-size: 0.9em; }
    .survey-grid td:first-child { text-align: left; font-weight: normal; width: 55%; }
    .survey-grid thead th:not(:first-child) { width: 9%; font-size: 0.85em; }
    .grid-header-note { margin-top: -10px; margin-bottom: 15px; font-size: 0.9em; color: #666; }
    .checkbox-group { display: flex; flex-direction: column; gap: 5px; padding-left: 10px; }
    .checkbox-item { display: flex; align-items: center; padding-top: 3px; padding-bottom: 3px;}
    .other-row { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
    .other-input { width: 100%; margin-top: 0; margin-bottom: 0; padding: 8px 10px; }
    @media screen and (max-width: 600px) {
        .container { padding: 10px; }
        .info-row { flex-direction: column; gap: 0; }
        .info-col, .ma-nv-col, .name-dept-col { flex-grow: 1; max-width: none; }
        .survey-grid { display: block; }
        .survey-grid thead { display: none; }
        .survey-grid tr { display: block; margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background-color: #fff; }
        .survey-grid td { border: none; display: block; text-align: left; width: 100%; padding: 2px 0; }
        .survey-grid td:first-child { font-weight: bold; margin-bottom: 5px; background-color: transparent; }
        .survey-grid td:not(:first-child) { display: inline-block; width: auto; margin-right: 15px; }
        .survey-grid td input[type="radio"] { transform: scale(1.2); }
        .other-row { flex-direction: column; align-items: flex-start; }
        .other-input { margin-left: 0; margin-top: 5px; width: 100%; }
        .checkbox-item { padding: 5px 0; }
    }
    </style>
</head>
<body>

<div class="container">
    <h1>{{ form_title }}</h1>
    <h2 class="subtitle">( Áp dụng từ cấp tổ trưởng trở lên)</h2>
    
    <p class="explanation">
        Mục đích: Khảo sát nhằm tìm hiểu nhu cầu và mong muốn đào tạo của các tổ trưởng sản xuất, từ đó xây dựng các chương trình nâng cao năng lực quản lý và hiệu quả công việc. Rất mong Anh/Chị dành thời gian điền đầy đủ phiếu khảo sát và đóng góp ý kiến, để phòng Nhân sự có kế hoạch tổ chức các lớp đào tạo mới trong năm 2026 thật hiệu quả, thiết thực và phù hợp với nhu cầu. <br>
        <strong>Ngày kết thúc khảo sát: 01/12/2025</strong>
    </p>
    
    <form id="surveyForm" action="/submit" method="POST">
        
        <div class="section-box section-a">
            <h3>A. Thông tin chung</h3>
            
            <div class="info-row">
                <div class="info-col ma-nv-col">
                    <label for="employeeCode">Nhập Mã NV:</label>
                    <input type="text" id="employeeCode" name="employeeCode" list="employeeList" required
                            onchange="populateEmployeeInfo(this.value)">
                    <datalist id="employeeList"></datalist>
                </div>
                
                <div class="info-col name-dept-col">
                    <label for="employeeName">Họ và Tên:</label>
                    <input type="text" id="employeeName" name="employeeName" readonly required>
                </div>
                
                <div class="info-col name-dept-col">
                    <label for="department">Bộ phận:</label>
                    <input type="text" id="department" name="department" readonly required>
                </div>
            </div>

            <div class="form-group">
                <label>Thâm niên ở vị trí hiện tại:</label>
                <div class="radio-group">
                    <label><input type="radio" name="Seniority" value="Dưới 01 năm" required> Dưới 01 năm</label>
                    <label><input type="radio" name="Seniority" value="Từ 01 - 03 năm"> Từ 01 - 03 năm</label>
                    <label><input type="radio" name="Seniority" value="Từ 03 - 05 năm"> Từ 03 - 05 năm</label>
                    <label><input type="radio" name="Seniority" value="Trên 05 năm"> Trên 05 năm</label>
                </div>
            </div>
        </div>
        
        <div class="section-box section-b">
            <h3>B. Tự Đánh Giá Các Năng Lực</h3>
            <div class="grid-header-note">(Thang điểm 1-5, 1: Kém, 2: Trung Bình, 3: Khá, 4: Giỏi, 5: Xuất sắc)</div>
            
            <table class="survey-grid">
                <thead>
                    <tr>
                        <th>Năng lực</th>
                        <th>1(Kém)</th>
                        <th>2(Trung Bình)</th>
                        <th>3(Khá)</th>
                        <th>4(Giỏi)</th>
                        <th>5(Xuất sắc)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1. Triển khai (thực hiện) kế hoạch và giám sát sản xuất</td>
                        <td><input type="radio" name="NL_1" value="1" required></td>
                        <td><input type="radio" name="NL_1" value="2"></td>
                        <td><input type="radio" name="NL_1" value="3"></td>
                        <td><input type="radio" name="NL_1" value="4"></td>
                        <td><input type="radio" name="NL_1" value="5"></td>
                    </tr>
                    <tr>
                        <td>2. Kiểm soát chất lượng (ISO, HACCP, GMP)</td>
                        <td><input type="radio" name="NL_2" value="1"></td>
                        <td><input type="radio" name="NL_2" value="2"></td>
                        <td><input type="radio" name="NL_2" value="3"></td>
                        <td><input type="radio" name="NL_2" value="4"></td>
                        <td><input type="radio" name="NL_2" value="5"></td>
                    </tr>
                    <tr>
                        <td>3. Quản lý nguyên vật liệu và kiểm soát lãng phí</td>
                        <td><input type="radio" name="NL_3" value="1"></td>
                        <td><input type="radio" name="NL_3" value="2"></td>
                        <td><input type="radio" name="NL_3" value="3"></td>
                        <td><input type="radio" name="NL_3" value="4"></td>
                        <td><input type="radio" name="NL_3" value="5"></td>
                    </tr>
                    <tr>
                        <td>4. Đảm bảo an toàn lao động và vệ sinh lao động</td>
                        <td><input type="radio" name="NL_4" value="1"></td>
                        <td><input type="radio" name="NL_4" value="2"></td>
                        <td><input type="radio" name="NL_4" value="3"></td>
                        <td><input type="radio" name="NL_4" value="4"></td>
                        <td><input type="radio" name="NL_4" value="5"></td>
                    </tr>
                    <tr>
                        <td>5. Đảm bảo an thực phẩm và vệ sinh công nghiệp</td>
                        <td><input type="radio" name="NL_5" value="1"></td>
                        <td><input type="radio" name="NL_5" value="2"></td>
                        <td><input type="radio" name="NL_5" value="3"></td>
                        <td><input type="radio" name="NL_5" value="4"></td>
                        <td><input type="radio" name="NL_5" value="5"></td>
                    </tr>
                    <tr>
                        <td>6. Phân công công việc và quản lý đội ngũ</td>
                        <td><input type="radio" name="NL_6" value="1"></td>
                        <td><input type="radio" name="NL_6" value="2"></td>
                        <td><input type="radio" name="NL_6" value="3"></td>
                        <td><input type="radio" name="NL_6" value="4"></td>
                        <td><input type="radio" name="NL_6" value="5"></td>
                    </tr>
                    <tr>
                        <td>7. Huấn luyện và kèm cặp nhân viên mới</td>
                        <td><input type="radio" name="NL_7" value="1"></td>
                        <td><input type="radio" name="NL_7" value="2"></td>
                        <td><input type="radio" name="NL_7" value="3"></td>
                        <td><input type="radio" name="NL_7" value="4"></td>
                        <td><input type="radio" name="NL_7" value="5"></td>
                    </tr>
                    <tr>
                        <td>8. Kỹ năng giao tiếp và truyền đạt thông tin</td>
                        <td><input type="radio" name="NL_8" value="1"></td>
                        <td><input type="radio" name="NL_8" value="2"></td>
                        <td><input type="radio" name="NL_8" value="3"></td>
                        <td><input type="radio" name="NL_8" value="4"></td>
                        <td><input type="radio" name="NL_8" value="5"></td>
                    </tr>
                    <tr>
                        <td>9. Giải quyết mâu thuẫn, xây dựng tinh thần đội nhóm</td>
                        <td><input type="radio" name="NL_9" value="1"></td>
                        <td><input type="radio" name="NL_9" value="2"></td>
                        <td><input type="radio" name="NL_9" value="3"></td>
                        <td><input type="radio" name="NL_9" value="4"></td>
                        <td><input type="radio" name="NL_9" value="5"></td>
                    </tr>
                    <tr>
                        <td>10. Kỹ năng giải quyết vấn đề và ra quyết định</td>
                        <td><input type="radio" name="NL_10" value="1"></td>
                        <td><input type="radio" name="NL_10" value="2"></td>
                        <td><input type="radio" name="NL_10" value="3"></td>
                        <td><input type="radio" name="NL_10" value="4"></td>
                        <td><input type="radio" name="NL_10" value="5"></td>
                    </tr>
                    <tr>
                        <td>11. Tư duy cải tiến liên tục (Kaizen)</td>
                        <td><input type="radio" name="NL_11" value="1"></td>
                        <td><input type="radio" name="NL_11" value="2"></td>
                        <td><input type="radio" name="NL_11" value="3"></td>
                        <td><input type="radio" name="NL_11" value="4"></td>
                        <td><input type="radio" name="NL_11" value="5"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="section-box section-c">
            <h3>C. Nhu Cầu Đào Tạo và Đề Xuất</h3>
            
            <div class="form-group">
                <label>1. Bạn muốn được đào tạo chuyên sâu về những kỹ năng nào? (Có thể chọn nhiều đáp án)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" name="NhuCauDT" value="Tổ trưởng sản xuất chuyên nghiệp"> Tổ trưởng sản xuất chuyên nghiệp</div>
                    <div class="checkbox-item"><input type="checkbox" name="NhuCauDT" value="Kỹ năng quản lý đội nhóm, tạo động lực và gắn kết"> Kỹ năng quản lý đội nhóm, tạo động lực và gắn kết</div>
                    <div class="checkbox-item"><input type="checkbox" name="NhuCauDT" value="Nâng cao năng lực quản lý sản xuất"> Nâng cao năng lực quản lý sản xuất</div>
                    <div class="checkbox-item"><input type="checkbox" name="NhuCauDT" value="Kỹ năng quản lý dây chuyền sản xuất và tối ưu hóa năng suất"> Kỹ năng quản lý dây chuyền sản xuất và tối ưu hóa năng suất</div>
                    <div class="checkbox-item"><input type="checkbox" name="NhuCauDT" value="Kỹ năng huấn luyện và kèm cặp (công nhân viên mới)"> Kỹ năng huấn luyện và kèm cặp (công nhân viên mới)</div>
                    <div class="checkbox-item"><input type="checkbox" name="NhuCauDT" value="An toàn thực phẩm và vệ sinh công nghiệp"> An toàn thực phẩm và vệ sinh công nghiệp</div>
                    <div class="checkbox-item"><input type="checkbox" name="NhuCauDT" value="Xử lý sự cố và rủi ro trong sản xuất"> Xử lý sự cố và rủi ro trong sản xuất</div>
                    <div class="checkbox-item"><input type="checkbox" name="NhuCauDT" value="Triển khai hoạt động Kaizen tại nhà máy"> Triển khai hoạt động Kaizen tại nhà máy</div>
                    
                    <div class="other-row">
                        <div class="checkbox-item" style="margin-bottom: 0; padding-top: 0; padding-bottom: 0;">
                            <input type="checkbox" id="otherNhuCauDT" name="NhuCauDT_OtherCheck" value="Khác"> Khác
                        </div>
                        <input type="text" id="otherNhuCauDTText" name="NhuCauDT_OtherText" class="other-input" placeholder="Nhập nhu cầu đào tạo khác nếu có" oninput="document.getElementById('otherNhuCauDT').checked = this.value.length > 0;">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="ThachThucCongViec">2. Bạn đang gặp phải những khó khăn, thách thức nào lớn nhất trong công việc hàng ngày? (Xin vui lòng mô tả chi tiết)</label>
                <textarea id="ThachThucCongViec" name="ThachThucCongViec" rows="4"></textarea>
            </div>
            
            <div class="form-group">
                <label>3. Bạn mong muốn hình thức đào tạo nào? (Có thể chọn nhiều đáp án)</label>
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" name="HinhThucDT" value="Đào tạo trực tiếp tại nhà máy (In-house training)"> Đào tạo trực tiếp tại nhà máy (In-house training)</div>
                    <div class="checkbox-item"><input type="checkbox" name="HinhThucDT" value="Tham gia các khóa học chuyên đề bên ngoài"> Tham gia các khóa học chuyên đề bên ngoài</div>
                    <div class="checkbox-item"><input type="checkbox" name="HinhThucDT" value="Tự học qua tài liệu, video (E-learning)"> Tự học qua tài liệu, video (E-learning)</div>
                </div>
            </div>

            <div class="form-group">
                <label for="DeXuatKhacMoi">4. Bạn có đề xuất hoặc ý kiến nào khác về các chương trình đào tạo sắp tới không? (Xin vui lòng mô tả chi tiết)</label>
                <textarea id="DeXuatKhacMoi" name="DeXuatKhacMoi" rows="4"></textarea>
            </div>
        </div>

        <button type="submit" id="submitButton">Gửi Khảo Sát</button>

        <div class="feedback hidden" id="loadingMessage">Đang xử lý... Vui lòng chờ.</div>
        <div class="feedback hidden" id="successMessage" style="color: green;">Gửi khảo sát thành công!</div>
        <div class="feedback hidden" id="errorMessage" style="color: red;">Đã xảy ra lỗi khi gửi. Vui lòng thử lại.</div>

    </form>
</div>

<script>
    let employeeData = [];

    document.addEventListener('DOMContentLoaded', function() {
        // 1. Tải danh sách nhân viên từ API Flask
        fetch('/get_employees')
            .then(response => response.json())
            .then(loadEmployeeList)
            .catch(error => console.error('Lỗi tải danh sách NV:', error));

        document.getElementById('surveyForm').addEventListener('submit', handleFormSubmit);
    });

    function loadEmployeeList(list) {
        employeeData = list;
        const datalist = document.getElementById('employeeList');
        
        list.forEach(emp => {
            if (emp.MaNV) {
                const option = document.createElement('option');
                option.value = emp.MaNV;
                datalist.appendChild(option);
            }
        });
    }

    function populateEmployeeInfo(maNV) {
        const nameInput = document.getElementById('employeeName');
        const deptInput = document.getElementById('department');
        const codeInput = document.getElementById('employeeCode');
        
        const trimmedMaNV = String(maNV).trim();
        
        const selectedEmployee = employeeData.find(emp => String(emp.MaNV).trim() === trimmedMaNV);

        if (selectedEmployee) {
            nameInput.value = selectedEmployee.HoTen || '';
            deptInput.value = selectedEmployee.BoPhan || '';
        } else {
            if (trimmedMaNV.length > 0) {
                nameInput.value = '';
                deptInput.value = '';
                
                alert("Không tìm thấy thông tin người khảo sát");
                
                codeInput.value = ''; 
            } else {
                nameInput.value = '';
                deptInput.value = '';
            }
        }
    }

    function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        
        const maNVInput = document.getElementById('employeeCode').value.trim();
        if (!employeeData.some(emp => String(emp.MaNV).trim() === maNVInput)) {
            alert("Mã Nhân Viên không hợp lệ hoặc không tìm thấy. Vui lòng nhập Mã NV chính xác.");
            return; 
        }

        document.getElementById('submitButton').disabled = true;
        document.getElementById('loadingMessage').classList.remove('hidden');
        document.getElementById('successMessage').classList.add('hidden');
        document.getElementById('errorMessage').classList.add('hidden');

        // Tạo FormData để gửi lên Flask
        const formData = new FormData(form);
        
        // Gửi dữ liệu bằng Fetch API
        fetch('/submit', {
            method: 'POST',
            body: new URLSearchParams(formData) // Flask nhận dữ liệu form-urlencoded
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Lỗi HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === "success") {
                onSuccess(data);
            } else {
                onFailure({ message: data.message || "Lỗi không xác định từ server." });
            }
        })
        .catch(error => {
            onFailure({ message: error.message || "Lỗi mạng hoặc server không phản hồi." });
        });
    }

    function onSuccess(data) {
        document.getElementById('loadingMessage').classList.add('hidden');
        
        document.getElementById('successMessage').classList.remove('hidden');
        document.getElementById('surveyForm').reset();
        document.getElementById('employeeName').value = '';
        document.getElementById('department').value = '';
        document.getElementById('otherNhuCauDTText').value = ''; 
        
        setTimeout(() => {
            document.getElementById('submitButton').disabled = false;
            document.getElementById('successMessage').classList.add('hidden');
        }, 3000);
    }

    function onFailure(error) {
        document.getElementById('loadingMessage').classList.add('hidden');
        document.getElementById('errorMessage').textContent = "Đã xảy ra lỗi: " + error.message;
        document.getElementById('errorMessage').classList.remove('hidden');
        document.getElementById('submitButton').disabled = false;
    }
</script>

</body>
</html>
